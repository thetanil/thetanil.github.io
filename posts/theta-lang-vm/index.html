<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Theta-lang: VM Design and Implementation | Theta Nil's Site</title><link rel=stylesheet href=/css/main.min.c7a5c1c6627bdd92510df0d2272d0f86694f49366048d0ee3065e20d315759b3.css integrity="sha256-x6XBxmJ73ZJRDfDSJy0PhmlPSTZgSNDuMGXiDTFXWbM=" crossorigin=anonymous><script src=/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js integrity="sha256-I80MfYNyY7nq65buLZzPopadqj+gD6HB/ocBqbhyUaE=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js></script><script>function getMermaidTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"default"}function initializeMermaid(){mermaid.initialize({startOnLoad:!1,theme:getMermaidTheme(),securityLevel:"loose",fontFamily:"inherit",themeVariables:{primaryColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#66b3ff":"#00e",primaryTextColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#e8e8e8":"#222",primaryBorderColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#444":"#222",lineColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#444":"#222",sectionBkgColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#2a2a2a":"#f9f9f9",altSectionBkgColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#1a1a1a":"#fff",gridColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#444":"#e0e0e0",tertiaryColor:window.matchMedia("(prefers-color-scheme: dark)").matches?"#3a3a3a":"#f0f0f0"}})}function processMermaidBlocks(){const e=document.querySelectorAll("code.language-mermaid");e.forEach((e,t)=>{const n=document.createElement("div");n.className="mermaid",n.id="mermaid-"+t,n.textContent=e.textContent;const s=e.parentElement;s.parentElement.replaceChild(n,s)}),e.length>0&&mermaid.init()}if(document.addEventListener("DOMContentLoaded",function(){initializeMermaid(),processMermaidBlocks()}),window.matchMedia){const e=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",function(){initializeMermaid();const t=document.querySelectorAll(".mermaid");t.forEach((e,t)=>{e.id="mermaid-rerender-"+t,e.removeAttribute("data-processed")}),t.length>0&&mermaid.init()})}</script></head><body><header><h1>Theta Nil's Site</h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><h1>Theta-lang: VM Design and Implementation</h1><time datetime=2025-11-25T00:00:00+00:00>November 25, 2025</time><h1 id=theta-lang-vm-design-and-implementation>Theta-lang: VM Design and Implementation</h1><p><a href=/posts/theta-lang-design-decisions/>Design Decisions</a>
<a href=/posts/theta-lang-implementation/>Implementation Plan</a>
<a href=/posts/theta-lang-feedback/>Developer Feedback & Questions</a>
<a href=/posts/theta-lang-recommendation/>Recommendations</a></p><p>This page consolidates all technical documentation, design decisions, implementation plans, developer feedback, and recommendations for the theta-lang virtual machine project. The content below is organized into major sections for clarity. Subpages may be created for deeper dives if needed.</p><h2 id=1-overview>1. Overview</h2><p>Theta-lang is a new virtual machine (VM) designed for embeddable, high-performance procedural and dataflow computation, with all runtime state and data represented using FlatBuffers. The VM is intended to be host-friendly, introspectable, and suitable for analytics, scripting, and integration with C, Rust, Python, and Go.</p><h2 id=2-core-design-decisions>2. Core Design Decisions</h2><h3 id=memory-model-arena-allocation>Memory Model: Arena Allocation</h3><ul><li>Arena-based allocation for FlatBuffer regions</li><li>Predictable lifecycle, zero fragmentation, fast O(1) allocation</li><li>Immutability: arenas are dropped as a unit, no GC or refcounting</li></ul><h3 id=register-architecture-typed-registers>Register Architecture: Typed Registers</h3><ul><li>256 statically typed registers per function (r0–r255)</li><li>Type tags: i8, i16, i32, i64, f32, f64, bool, ptr, string, table_ref, node_ref</li><li>r0: constant zero, r1: return value, r2–r15: arguments, r16–r255: general purpose</li></ul><h3 id=procedural-language-typed-c-like>Procedural Language: Typed, C-like</h3><ul><li>Statically typed, imperative, C-like syntax</li><li>No implicit conversions, no GC, no OOP</li><li>Control flow: if/else, while, for, break, continue, return</li></ul><h3 id=table-storage-columnar-layout>Table Storage: Columnar Layout</h3><ul><li>Tables use columnar storage with typed columns</li><li>Null bitmap for nullable columns, special handling for strings</li><li>Optimized for OLAP queries, SIMD, and cache locality</li></ul><h3 id=dataflow-execution-pull-based-lazy-evaluation>Dataflow Execution: Pull-Based Lazy Evaluation</h3><ul><li>Dataflow nodes form a DAG, executed lazily via pull-based iterators</li><li>Host triggers materialization, enabling optimization and memory efficiency</li></ul><h2 id=3-implementation-plan>3. Implementation Plan</h2><p>Phased approach:</p><ul><li><strong>Phase 1:</strong> FlatBuffer schema design (types, memory, values, instructions, program, execution, operators, dataflow, tables, integration, stdlib)</li><li><strong>Phase 2:</strong> Procedural interpreter core (typed instructions, register file, call stack)</li><li><strong>Phase 3:</strong> Dataflow engine (operators, DAG, iterators, materialization)</li><li><strong>Phase 4:</strong> Integration layer (procedural-dataflow bridge, buffer management)</li><li><strong>Phase 5:</strong> Host API and bindings (C, Python, Rust, Go)</li><li><strong>Phase 6+:</strong> Advanced operators, safety, tooling, standard library, optimization</li></ul><h2 id=4-developer-feedback--open-questions>4. Developer Feedback & Open Questions</h2><p>A comprehensive set of clarifying questions and feedback from developers is maintained to guide implementation and avoid costly refactoring. Topics include:</p><ul><li>FlatBuffer schema evolution and organization</li><li>Buffer ownership and lifecycle</li><li>Calling conventions and control flow encoding</li><li>Instruction encoding density</li><li>Streaming vs. batch processing</li><li>Thread safety and host API abstraction</li><li>Error handling, debugging, and profiling</li><li>Security, testing, and deployment</li></ul><h2 id=5-recommendations>5. Recommendations</h2><ul><li>Use multiple .fbs files for schema organization</li><li>Store strings as UTF-8, consider interning for repeated values</li><li>Batched updates for ExecutionState, not per instruction</li><li>Argument registers (r2–r15) with stack fallback</li><li>Absolute offsets for branch targets</li><li>Fixed-size instructions (32-bit) for core ISA</li><li>Support both streaming and batching in dataflow</li><li>Start with single-threaded VM core, allow concurrent host access to FlatBuffers</li></ul><h2 id=6-detailed-design-documents>6. Detailed Design Documents</h2><h3 id=61-design-decisions>6.1 Design Decisions</h3><p>See <a href=#core-design-decisions>Design Decisions</a> for rationale and technical implications.</p><h3 id=62-implementation-plan>6.2 Implementation Plan</h3><p>See <a href=#implementation-plan>Implementation Plan</a> for phased deliverables and timeline.</p><h3 id=63-developer-questions>6.3 Developer Questions</h3><p>See <a href=#developer-feedback--open-questions>Developer Feedback & Open Questions</a> for all clarifications and priorities.</p><h3 id=64-recommendations>6.4 Recommendations</h3><p>See <a href=#recommendations>Recommendations</a> for architectural choices and next steps.</p><h2 id=7-next-steps>7. Next Steps</h2><ul><li>Review and validate plan with stakeholders</li><li>Begin schema design and initial interpreter prototype</li><li>Iterate based on feedback and implementation learnings</li></ul><hr><p><em>This page is a living document. For deeper technical details, see the subpages or contact the development team.</em></p><div><div>Tags:</div><ul><li><a href=/tags/theta-lang/>Theta-Lang</a></li><li><a href=/tags/vm/>Vm</a></li><li><a href=/tags/design/>Design</a></li><li><a href=/tags/flatbuffers/>Flatbuffers</a></li><li><a href=/tags/dataflow/>Dataflow</a></li></ul></div></main><footer><p>Copyright 2025. All rights reserved.</p></footer></body></html>